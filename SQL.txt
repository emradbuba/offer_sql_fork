CREATE TABLE OFFER_TYPES
(
    typeId   NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY ,
    typeName VARCHAR2(50) NOT NULL,
    CONSTRAINT pk_offers_type PRIMARY KEY (typeId)
);

INSERT INTO OFFER_TYPES (typeName) VALUES ('HEALTH_OFFER');
INSERT INTO OFFER_TYPES (typeName) VALUES ('LIFE_OFFER');
INSERT INTO OFFER_TYPES (typeName) VALUES ('CAR_OFFER');
INSERT INTO OFFER_TYPES (typeName) VALUES ('ACCIDENT_OFFER');

CREATE TABLE OFFERS
(
    offerId      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    offerNr      VARCHAR2(6),
    offerName    VARCHAR2(50)  NOT NULL,
    offerType    NUMBER        NOT NULL,
    price        NUMBER(10, 2) NOT NULL,
    creationDate TIMESTAMP DEFAULT CURRENT_DATE,
    validUntil   DATE,
    CONSTRAINT pk_offers PRIMARY KEY (offerId),
    CONSTRAINT fk_offers_offersType FOREIGN KEY (offerType) REFERENCES OFFER_TYPES (typeId)
);

CREATE TABLE OFFER_LOG
(
    id            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    offerId       NUMBER,
    operationType VARCHAR(50),
    operationTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_offerLog PRIMARY KEY (id),
    CONSTRAINT fk_offerLog_offers FOREIGN KEY (offerId) REFERENCES OFFERS (offerId)
);

CREATE TABLE PERSON
(
    personId  NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    personNr  VARCHAR2(6),
    firstName VARCHAR2(50) NOT NULL,
    lastName  VARCHAR2(50) NOT NULL,
    birthDay  DATE         NOT NULL,
    street    VARCHAR2(50),
    city      VARCHAR2(50),
    CONSTRAINT pk_person PRIMARY KEY (personId)
);

CREATE OR REPLACE TRIGGER trigger_offer
    AFTER INSERT OR UPDATE OR DELETE ON OFFERS
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        INSERT INTO OFFER_LOG (offerId, operationType, operationTime) VALUES (1, 'INSERT', SYSDATE);
    ELSIF UPDATING THEN
        INSERT INTO OFFER_LOG (offerId, operationType, operationTime) VALUES (1, 'UPDATE', SYSDATE);
    ELSIF DELETING THEN
        INSERT INTO OFFER_LOG (offerId, operationType, operationTime) VALUES (1, 'DELETE', SYSDATE);
    end if;
end;

CREATE USER C##Jan IDENTIFIED BY ghi084572;
GRANT CONNECT, RESOURCE, DBA TO C##Jan
