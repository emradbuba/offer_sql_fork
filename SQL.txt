ALTER SESSION SET "_ORACLE_SCRIPT"=true;
CREATE USER C##JAN IDENTIFIED BY ghi084572;



CREATE TABLE OFFER_TYPES
(
    type_Id   NUMBER GENERATED BY DEFAULT AS IDENTITY(START WITH 1 INCREMENT BY 1) PRIMARY KEY ,
    type_Name VARCHAR2(50) NOT NULL
);

INSERT INTO OFFER_TYPES (type_Name) VALUES ('HEALTH_OFFER');
INSERT INTO OFFER_TYPES (type_Name) VALUES ('LIFE_OFFER');
INSERT INTO OFFER_TYPES (type_Name) VALUES ('CAR_OFFER');
INSERT INTO OFFER_TYPES (type_Name) VALUES ('ACCIDENT_OFFER');

CREATE TABLE OFFERS
(
    offer_Id      NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    offer_Nr      VARCHAR2(6),
    offer_Name    VARCHAR2(50)  NOT NULL,
    offer_Type    NUMBER        NOT NULL,
    price        NUMBER(10, 2) NOT NULL,
    creation_Date DATE DEFAULT TRUNC(SYSDATE),
    valid_Until   DATE,
    CONSTRAINT fk_offers_offersType FOREIGN KEY (offer_Type) REFERENCES OFFER_TYPES (type_Id)
);

CREATE TABLE OFFER_LOG
(
    id            NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    offer_Id       NUMBER,
    operation_Type VARCHAR(50),
    operation_Time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_offerLog_offers FOREIGN KEY (offer_Id) REFERENCES OFFERS (offer_Id)
);

CREATE TABLE PERSON
(
    person_Id  NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    person_Nr  VARCHAR2(6),
    first_Name VARCHAR2(50) NOT NULL,
    last_Name  VARCHAR2(50) NOT NULL,
    birthday  DATE         NOT NULL,
    street    VARCHAR2(50),
    city      VARCHAR2(50)
);

CREATE OR REPLACE TRIGGER trigger_offer
    AFTER INSERT OR UPDATE OR DELETE ON OFFERS
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        INSERT INTO OFFER_LOG (offer_Id, operation_Type, operation_Time) VALUES (:NEW.offer_Id, 'INSERT', SYSDATE);
    ELSIF UPDATING THEN
        INSERT INTO OFFER_LOG (offer_Id, operation_Type, operation_Time) VALUES (:NEW.offer_Id, 'UPDATE', SYSDATE);
    ELSIF DELETING THEN
        INSERT INTO OFFER_LOG (offer_Id, operation_Type, operation_Time) VALUES (:OLD.offer_Id, 'DELETE', SYSDATE);
    END IF;
END;


COMMIT;

CREATE USER C##Jan IDENTIFIED BY ghi084572;
GRANT CONNECT, RESOURCE, DBA TO C##Jan;


ALTER TABLE OFFER_LOG DROP CONSTRAINT fk_offerLog_offers;
ALTER TABLE OFFERS DROP CONSTRAINT FK_OFFERS_OFFERSTYPE;
DROP TABLE OFFER_LOG;
DROP TABLE OFFERS;
DROP TABLE OFFER_TYPES;
DROP TABLE PERSON;




